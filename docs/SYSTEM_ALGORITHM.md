# Алгоритм работы системы To The Moon

## Обзор системы

To The Moon - это система автоматического скоринга токенов Solana, которая отслеживает миграции токенов с Pump.fun на внешние DEX платформы и оценивает их торговый потенциал.

## 1. Поступление токенов в систему

### 1.1 WebSocket мониторинг Pump.fun
**Файл:** `src/workers/pumpfun_ws.py`

- **Источник:** WebSocket подключение к `wss://pumpportal.fun/api/data`
- **Процесс:**
  1. Воркер подключается к Pump.fun WebSocket API
  2. Получает события миграций токенов в реальном времени
  3. Извлекает данные: `mint`, `name`, `symbol`
  4. Создает записи в БД со статусом `monitoring`

**Параметры запуска:**
- `PUMPFUN_RUN_SECONDS` - время работы воркера (по умолчанию 120 сек)

### 1.2 Создание записи токена
**Файл:** `src/adapters/repositories/tokens_repo.py`

Новый токен создается с:
- `status = "monitoring"`
- `created_at = текущее время`
- `mint_address, name, symbol` из WebSocket

## 2. Жизненный цикл токена

### 2.1 Статусы токенов
1. **monitoring** - новые токены, ожидающие активации
2. **active** - токены с достаточной ликвидностью на внешних DEX
3. **archived** - токены, исключенные из активного мониторинга

### 2.2 Переход monitoring → active
**Файл:** `src/scheduler/tasks.py` → `enforce_activation_once()`
**Файл:** `src/domain/validation/dex_rules.py` → `check_activation_conditions()`

**Условия активации (ИЛИ):**
1. **Условие 1:** Пул на Pump.fun + хотя бы один внешний пул с ликвидностью ≥ `activation_min_liquidity_usd`
2. **Условие 2:** Более двух внешних пулов с ликвидностью ≥ `activation_min_liquidity_usd`

**Параметры:**
- `activation_min_liquidity_usd` (по умолчанию: 200 USD)

**Исключения:**
- Bonding curve платформы: `pumpfun`, `launchlab`
- Учитываются только WSOL/SOL и USDC пулы

### 2.3 Переход active → monitoring
Если токен больше не соответствует условиям активации.

### 2.4 Архивирование токенов
**Файл:** `src/scheduler/tasks.py` → `archive_once()`

**Условия архивирования:**
- Токены в статусе `monitoring` старше `monitoring_timeout_hours` (текущее: 48 часов)
- Токены в статусе `active` со скором < `min_score` старше `archive_below_hours` (текущее: 24 часа)

## 3. Система скоринга

### 3.1 Планировщик обновлений
**Файл:** `src/scheduler/service.py` → `_process_group()`

**Группы токенов:**
- **hot** - токены со скором ≥ `min_score` (обновляются каждые `hot_interval_sec` = 10 сек)
- **cold** - токены со скором < `min_score` (обновляются каждые `cold_interval_sec` = 30 сек)

### 3.2 Дифференцированная фильтрация данных
**Файл:** `src/domain/scoring/scoring_service.py`

**Пороги ликвидности по статусам:**
- **monitoring токены:** `activation_min_liquidity_usd` = 200 USD (мягкая фильтрация)
- **active токены:** `min_pool_liquidity_usd` = 200 USD (жесткая фильтрация)

### 3.3 Сбор метрик
**Файл:** `src/domain/metrics/enhanced_dex_aggregator.py`

**Процесс:**
1. Получение пар от DexScreener API
2. Фильтрация по ликвидности (зависит от статуса токена)
3. Исключение DEX: `pumpfun`, `launchlab`
4. Агрегация метрик по WSOL/SOL и USDC парам

**Собираемые метрики:**
- `L_tot` - общая ликвидность (USD)
- `tx_count_5m`, `tx_count_1h` - количество транзакций
- `volume_5m`, `volume_1h` - объемы торгов
- `delta_p_5m`, `delta_p_15m` - изменения цены
- `buys_volume_5m`, `sells_volume_5m` - оценочные объемы покупок/продаж
- `hours_since_creation` - время с создания токена

## 4. Hybrid Momentum модель скоринга

### 4.1 Архитектура модели
**Файл:** `src/domain/scoring/hybrid_momentum_model.py`

**Компоненты скора:**
1. **tx_accel** - ускорение транзакций (25% веса)
2. **vol_momentum** - моментум объема (25% веса)
3. **token_freshness** - свежесть токена (25% веса)
4. **orderflow_imbalance** - дисбаланс ордерфлоу (25% веса)

> **Важно:** Система использует дифференцированную фильтрацию - monitoring токены обрабатываются с мягкими порогами (1 транзакция, $1 объем), active токены - с жесткими порогами (180 транзакций, $200 объем). Это позволяет раннее обнаружение перспективных токенов и точную оценку зрелых токенов.

### 4.2 Дифференцированные пороги активности
**Файл:** `src/domain/scoring/component_calculator.py`

**Для monitoring токенов (мягкие пороги):**
- `min_tx_threshold_5m: 1.0` - минимум 1 транзакция за 5 мин
- `min_tx_threshold_1h: 1.0` - минимум 1 транзакция за 1 час
- `min_volume_threshold_5m: 1.0` - минимум $1 объема за 5 мин
- `min_volume_threshold_1h: 1.0` - минимум $1 объема за 1 час
- `min_orderflow_volume_5m: 1.0` - минимум $1 для анализа ордерфлоу

**Для active токенов (жесткие пороги, настраиваются в БД):**
- `min_tx_threshold_5m: 180` (текущее) - минимум 180 транзакций за 5 мин
- `min_tx_threshold_1h: 1000` (текущее) - минимум 1000 транзакций за 1 час
- `min_volume_threshold_5m: 200` (текущее) - минимум $200 объема за 5 мин
- `min_volume_threshold_1h: 500` (текущее) - минимум $500 объема за 1 час
- `min_orderflow_volume_5m: 500.0` (по умолчанию) - минимум $500 для анализа ордерфлоу

### 4.3 Расчет компонентов

#### Transaction Acceleration (tx_accel)
```python
rate_5m = tx_count_5m / 5.0  # Транзакций в минуту за 5 мин
rate_1h = tx_count_1h / 60.0  # Транзакций в минуту за 1 час

# Логарифмическое сглаживание для предотвращения экстремальных значений
numerator = log(1 + rate_5m)
denominator = log(1 + rate_1h)
tx_accel = numerator / denominator  # Ограничено максимумом 10.0
```
- Показывает ускорение торговой активности относительно среднего уровня
- Логарифмическое сглаживание предотвращает экстремальные скачки
- Значение > 1 означает рост активности

#### Volume Momentum (vol_momentum)
```python
avg_5m_volume = volume_1h / 12.0  # Средний 5-минутный объем за час
base_momentum = volume_5m / avg_5m_volume

# Фактор ликвидности (сигмоидная функция)
liquidity_factor = sqrt(min(1.0, liquidity_usd / 100000.0))
vol_momentum = base_momentum * liquidity_factor
```
- Сравнивает текущий 5-минутный объем со средним за час
- Фактор ликвидности дает преимущество токенам с высокой ликвидностью
- Квадратный корень снижает экстремальные различия

#### Token Freshness (token_freshness)
```python
freshness = (threshold_hours - hours_since_creation) / threshold_hours
token_freshness = max(0.0, freshness)  # Ограничено диапазоном [0, 1]
```
- `threshold_hours` = 6.0 часов (по умолчанию)
- Токены младше 6 часов получают оценку от 1.0 до 0.0
- Токены старше 6 часов получают 0.0

#### Orderflow Imbalance (orderflow_imbalance)
```python
total_volume = buys_volume_5m + sells_volume_5m
volume_imbalance = (buys_volume_5m - sells_volume_5m) / total_volume

# Значимость на основе объема торгов
volume_significance = min(1.0, total_volume / 500.0)

# Детекция манипуляций (опционально)
if avg_trade_size > 3x_average:
    volume_significance *= 0.5

orderflow_imbalance = volume_imbalance * volume_significance
```
- Показывает преобладание покупок (+) или продаж (-)
- Учитывает только значимые объемы (≥ $500 для полного веса)
- Защита от манипуляций крупными единичными сделками
- Диапазон: [-1.0, 1.0]

### 4.4 Финальный расчет скора

#### Взвешенная сумма компонентов
```python
final_score = (w_tx * tx_accel) + (w_vol * vol_momentum) + 
              (w_fresh * token_freshness) + (w_oi * orderflow_imbalance)
```

**Веса по умолчанию:**
- `w_tx = 0.25` (25%) - вес ускорения транзакций
- `w_vol = 0.25` (25%) - вес моментума объема  
- `w_fresh = 0.25` (25%) - вес свежести токена
- `w_oi = 0.25` (25%) - вес дисбаланса ордерфлоу

#### EWMA сглаживание
**Параметр:** `ewma_alpha = 0.3`

```python
smoothed_score = alpha * raw_score + (1 - alpha) * previous_smoothed_score
```

- Сглаживает резкие колебания скора
- Новые данные влияют на 30%, исторические на 70%
- Обеспечивает стабильность ранжирования

## 5. Настройки системы

### 5.1 Конфигурационные файлы
- **Дефолты:** `src/domain/settings/defaults.py`
- **База данных:** таблица `app_settings`
- **Веб-интерфейс:** `frontend/src/pages/Settings.tsx`

### 5.2 Ключевые параметры

#### Веса компонентов
- `w_tx: 0.25` - вес ускорения транзакций
- `w_vol: 0.25` - вес моментума объема
- `w_fresh: 0.25` - вес свежести токена
- `w_oi: 0.25` - вес дисбаланса ордерфлоу

#### Пороги активности
- `min_score: 0.10` - минимальный скор для отображения
- `activation_min_liquidity_usd: 200` - порог активации токенов
- `min_pool_liquidity_usd: 200` - порог фильтрации пулов при скоринге

#### Временные интервалы
- `hot_interval_sec: 10` - интервал обновления активных токенов
- `cold_interval_sec: 30` - интервал обновления неактивных токенов
- `monitoring_timeout_hours: 48` - таймаут для monitoring токенов
- `archive_below_hours: 24` - время до архивирования неактивных токенов

#### Сглаживание
- `ewma_alpha: 0.3` - параметр EWMA сглаживания
- `freshness_threshold_hours: 6.0` - порог свежести токенов

## 6. API и интерфейсы

### 6.1 REST API
**Файл:** `src/app/routes/tokens.py`

**Основные эндпоинты:**
- `GET /tokens` - список токенов с фильтрацией по статусу
- `GET /tokens/{mint_address}` - детальная информация о токене
- `GET /settings` - получение настроек
- `PUT /settings/{key}` - обновление настроек

### 6.2 Веб-интерфейс
**Файл:** `frontend/src/pages/`

- **Dashboard** - основная страница с токенами
- **Settings** - управление параметрами системы
- **Token Details** - детальная информация о токене

## 7. Мониторинг и стабильность

### 7.1 Система мониторинга
**Файлы:** `src/monitoring/`

- **Health Monitor** - проверка состояния системы
- **Circuit Breaker** - защита от перегрузок
- **Retry Manager** - управление повторными попытками
- **Alert Manager** - система уведомлений

### 7.2 Обработка ошибок
- **Fallback Handler** - резервная обработка при сбоях
- **Resilient DexScreener Client** - устойчивый клиент API
- **Load Processor** - адаптация нагрузки

## 8. Интеграции

### 8.1 NotArb Bot
**Файл:** `src/integrations/notarb_pools.py`

- Экспорт токенов со скором ≥ `notarb_min_score` (0.5)
- Формат JSON для торгового бота
- Автоматическое обновление каждые 5 секунд

### 8.2 External APIs
- **DexScreener API** - данные о торговых парах
- **Pump.fun WebSocket** - события миграций токенов

## 9. Обработка различных сценариев

### 9.1 Новый токен (monitoring)
1. **Поступление:** WebSocket → создание записи со статусом `monitoring`
2. **Первичная оценка:** Мягкие пороги (1 транзакция, $1 объем)
3. **Результат:** Быстрое получение ненулевых компонентов для раннего обнаружения
4. **Переход:** При достижении ликвидности ≥ $200 → статус `active`

### 9.2 Активный токен (active)
1. **Условие:** Внешние пулы с ликвидностью ≥ $200
2. **Фильтрация:** Жесткие пороги (100+ транзакций, $500+ объем)
3. **Результат:** Точная оценка только значимых токенов
4. **Деградация:** При потере ликвидности → статус `monitoring`

### 9.3 Обработка ошибок
1. **API недоступен:** Circuit Breaker + Retry Manager
2. **Некорректные данные:** Fallback к нулевым компонентам
3. **Экстремальные значения:** Логарифмическое сглаживание + ограничения
4. **Манипуляции:** Детекция крупных единичных сделок

### 9.4 Адаптация нагрузки
1. **Высокая нагрузка:** Уменьшение размера батчей
2. **Низкая активность:** Увеличение интервалов обновления
3. **Приоритизация:** Hot токены обновляются чаще cold токенов

## 10. Метрики производительности

### 10.1 Временные характеристики
- **Hot токены:** Обновление каждые 10 секунд
- **Cold токены:** Обновление каждые 30 секунд
- **Активация:** Проверка каждые 60 секунд
- **Архивирование:** Проверка каждые 300 секунд

### 10.2 Пропускная способность
- **Базовый размер батча:** 30 hot / 20 cold токенов
- **Адаптивное масштабирование:** В зависимости от нагрузки системы
- **API лимиты:** Таймауты 3-5 секунд для DexScreener

### 10.3 Качество данных
- **Валидация:** Проверка консистентности метрик
- **Фильтрация:** Исключение аномальных изменений цен
- **Предупреждения:** Логирование проблем качества данных

## Заключение

Система работает как многоуровневый конвейер:

1. **Поступление** токенов через WebSocket → статус `monitoring`
2. **Раннее обнаружение** с мягкими порогами для быстрой реакции
3. **Активация** при достижении порогов ликвидности → статус `active`
4. **Точная оценка** с жесткими порогами для надежности
5. **Сглаживание** скоров через EWMA для стабильности
6. **Архивирование** неактивных токенов для оптимизации
7. **Экспорт** лучших токенов для торговых ботов

**Ключевые преимущества:**
- **Дифференцированная фильтрация** по статусам токенов
- **Устойчивость к манипуляциям** через детекцию аномалий
- **Адаптивная нагрузка** для стабильной работы
- **Раннее обнаружение** перспективных токенов
- **Точная оценка** зрелых токенов