Scoring v2 — «Потенциал для арбитража» (без ончейна)
===================================================

Цель
----
- Не ловить сделку «здесь и сейчас», а ранжировать монеты по вероятности скорого появления окна для арбитража.
- Опираемся только на агрегаторы (DexScreener/Birdeye), без ончейн‑срезов.
- Pump.fun (classic) исключаем, pumpswap учитываем. Приоритет — SOL/WSOL; USDC — как дополнительный сигнал зрелости.

Обозначения и наборы пулов
--------------------------
- P_all — все пулы монеты, исключая classic `pumpfun` (включая `pumpswap` и внешние DEX).
- P_ext — «внешние» пулы: исключая classic `pumpfun` и (по желанию) `pumpswap` — используются для оценки исполнимости.
  - По умолчанию: P_ext = все, кроме classic `pumpfun` (т.е. `pumpswap` учитывается в общей картине, но метрики исполнимости считаем по внешним DEX; см. ниже).
- Quote‑типы: SOL/WSOL и USDC (узнаём по адресам квот: WSOL = `So111…`, USDC = `EPjF…`).
- Primary пара (для кратких Δ): наиболее ликвидная SOL/WSOL; при отсутствии — fallback на USDC.

Метрики (1 снапшот)
-------------------
Считаем из данных агрегатора per‑pair: `priceUsd`, `liquidity.usd`, `volume.m5`, `txns.m5.{buys,sells}`, `dex/platform`, `quote`.

1) Разноценность A (без fee)
- Множество цен по пулам: PriceSet = {priceUsd(pair) | pair ∈ P_all}.
- Относительная «вилка»: D = (max − min) / ((max + min) / 2).
- Нормализация: A = clip(D / τ_D), τ_D ≈ 0.01 (1%).

2) Персистентность Pst
- По последним K снапшотам (напр., K=12): доля, где D ≥ d_min (например, d_min=0.003, 0.3%).

3) Многопуловость N
- N = clip((|P_ext| − 1) / 3). Хотим минимум 2 внешних пула.

4) Диверсификация котировок Q
- Q = 1, если в P_ext есть оба типа котировки (SOL/WSOL и USDC), иначе 0.
- Важно: это бонусный признак, не базовый.

5) Оборот V (исполняемость «жизни» во внешних)
- volume_ext_5m = Σ volume.m5(pair) по P_ext.
- L_ext = Σ liquidity.usd(pair) по P_ext.
- V = clip( (volume_ext_5m / (L_ext + ε)) / τ_U ), τ_U ≈ 0.02 (2% за 5 минут).

6) Двусторонность B (по внешним)
- buys_ext_5m = Σ buys, sells_ext_5m = Σ sells по P_ext.
- B = 2 · min(buys_ext_5m, sells_ext_5m) / (buys_ext_5m + sells_ext_5m).

7) Баланс ликвидности Lb (по внешним)
- Lb = min(L_i) / max(L_i) среди пула ликвидностей из P_ext (0..1).

Итоговый скор «Потенциал»
-------------------------
P = W_a·A + W_p·Pst + W_n·N + W_q·Q + W_v·V + W_b·B + W_l·Lb

Рекомендуемые веса (сумма ≈ 1):
- W_a=0.30, W_p=0.20, W_n=0.15, W_q=0.05, W_v=0.10, W_b=0.10, W_l=0.10

Интерпретация:
- A, Pst — «натяжение» цен между пулами и его регулярность (ранний сигнал окна).
- N, Q — есть где арбитражить (несколько внешних пулов; наличие USDC — признак зрелости).
- V, B — исполнимость во внешних пулах (не односторонний рыночный шум).
- Lb — отсутствие сильного дисбаланса между внешними пулами.

SOL/WSOL‑центричность и роль USDC
---------------------------------
- Primary и краткие Δ — всегда по самой ликвидной SOL/WSOL (fallback на USDC при отсутствии).
- Метрики исполнимости (V, B, Lb) считаем по внешним пулам; при этом `pumpswap` можно включать/исключать из P_ext в зависимости от стратегии.
- USDC — бонусный сигнал (Q), не доминирует над SOL/WSOL.

Активация/демоция (контекст)
----------------------------
- Правило активации/демоции остаётся прагматичным (как в коде): «есть внешний пул(ы) с ликвидностью ≥ threshold»; порог в настройках.
- Можно дополнить soft‑фильтрами по N (≥2) и/или Q (наличие USDC) — опционально.

Нормировки и защитные пороги
----------------------------
- τ_D (нормировка A): 0.01 по умолчанию.
- τ_U (нормировка V): 0.02 по умолчанию.
- d_min (для Pst): 0.003 (0.3%).
- K (окно Pst): 12…24 последних снапшотов.
- min_liq_per_pair_usd: игнорировать «пылинку» (например, < 500–1000 USD) при расчёте A/N/Lb.

Источники данных (агрегаторы)
-----------------------------
- DexScreener или Birdeye (предпочтительно Birdeye, есть OHLCV и trades):
  - Пары по mint: dex/platform, pairAddress, base/quote.
  - Ликвидность per pair: liquidity.usd.
  - OHLCV 5m/15m: для расчёта Δ (только для отображения/сравнений, скор P не зависит от Δ напрямую).
  - Трейды: для buys/sells (B, N_5m), объёмы m5 (V).
  - DEX‑маппинг: classic `pumpfun` исключаем; `pumpswap` учитываем; внешние — meteora/raydium/orca/…

Настройки (предложение по ключам)
---------------------------------
- tau_dispersion, tau_turnover, d_min, k_snapshots_for_persistence, min_liq_per_pair_usd.
- include_pumpswap_in_externals: true/false — участвует ли `pumpswap` в P_ext (по умолчанию false для V/B/Lb).
- include_usdc_in_metrics: true/false — влияет ли USDC на N/Lb/V/B (по умолчанию true, но вес Q низкий).
- Веса W_* — настраиваемые.

План внедрения (минимально инвазивно)
-------------------------------------
1) Адаптер данных (Birdeye/DexScreener): методы для pairs, ohlcv(5m/15m), trades(5m), liquidity.
2) Агрегатор метрик: расчёт A, N, Q, V, B, Lb, Pst; запись в metrics снапшота.
3) Скорер: вычисление P по весам.
4) UI: колонка «Потенциал», в карточке — расшифровка компонент и вкладов.

Примечания
----------
- «Без fee»: мы не оцениваем прибыльность, а только «натяжение» цен и структурную готовность рынка.
- Pumpswap не штрафуем, но метрики исполнимости считаем по внешним пулам — ближе к реальному исполнению.
