#!/usr/bin/env python3
"""
–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —É–ª—É—á—à–µ–Ω–∏–π –≤ —Ñ–æ—Ä–º—É–ª–∞—Ö —Å–∫–æ—Ä–∏–Ω–≥–∞.
–°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Å—Ç–∞—Ä—ã–µ –∏ –Ω–æ–≤—ã–µ –≤–µ—Ä—Å–∏–∏ —Ñ–æ—Ä–º—É–ª.
"""

from __future__ import annotations

import math
import sys
import logging
from src.core.json_logging import configure_logging


def _clip01(x: float) -> float:
    """–§—É–Ω–∫—Ü–∏—è –∫–ª–∏–ø–ø–∏–Ω–≥–∞ –∫ –¥–∏–∞–ø–∞–∑–æ–Ω—É [0, 1]."""
    return max(0.0, min(1.0, x))


def old_formulas(dp5: float, dp15: float) -> tuple[float, float]:
    """–°—Ç–∞—Ä—ã–µ —Ñ–æ—Ä–º—É–ª—ã —Å –ø—Ä–æ–±–ª–µ–º–∞–º–∏."""
    # –°—Ç–∞—Ä–∞—è —Ñ–æ—Ä–º—É–ª–∞ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ - —Å–ª–∏—à–∫–æ–º —Ä–µ–∑–∫–∞—è
    s_old = _clip01(dp5 / 0.1)
    
    # –°—Ç–∞—Ä–∞—è —Ñ–æ—Ä–º—É–ª–∞ momentum - –ø—Ä–æ–±–ª–µ–º–∞ –¥–µ–ª–µ–Ω–∏—è –Ω–∞ –º–∞–ª—ã–µ —á–∏—Å–ª–∞
    m_old = _clip01(dp5 / (dp15 + 0.001))
    
    return s_old, m_old


def new_formulas(dp5: float, dp15: float) -> tuple[float, float]:
    """–ù–æ–≤—ã–µ —É–ª—É—á—à–µ–Ω–Ω—ã–µ —Ñ–æ—Ä–º—É–ª—ã."""
    # –ù–æ–≤–∞—è —Ñ–æ—Ä–º—É–ª–∞ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ - –ª–æ–≥–∞—Ä–∏—Ñ–º–∏—á–µ—Å–∫–æ–µ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ
    s_new = _clip01(math.log(1 + dp5 * 10) / math.log(11)) if dp5 > 0 else 0.0
    
    # –ù–æ–≤–∞—è —Ñ–æ—Ä–º—É–ª–∞ momentum - –∑–∞—â–∏—Ç–∞ –æ—Ç –¥–µ–ª–µ–Ω–∏—è –Ω–∞ –º–∞–ª—ã–µ —á–∏—Å–ª–∞
    m_new = _clip01(dp5 / max(abs(dp15), 0.01))
    
    return s_new, m_new


def demo_improvements():
    """–î–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç —É–ª—É—á—à–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º—É–ª–∞—Ö."""
    configure_logging(level="INFO")
    
    print("–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —É–ª—É—á—à–µ–Ω–∏–π —Ñ–æ—Ä–º—É–ª —Å–∫–æ—Ä–∏–Ω–≥–∞")
    print("=" * 50)
    print()
    
    # –¢–µ—Å—Ç–æ–≤—ã–µ —Å–ª—É—á–∞–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –ø—Ä–æ–±–ª–µ–º—ã —Å—Ç–∞—Ä—ã—Ö —Ñ–æ—Ä–º—É–ª
    test_cases = [
        # (dp5, dp15, –æ–ø–∏—Å–∞–Ω–∏–µ)
        (0.05, 0.08, "–ù–æ—Ä–º–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è"),
        (0.12, 0.001, "–ú–∞–ª–æ–µ dp15 - –ø—Ä–æ–±–ª–µ–º–∞ momentum"),
        (0.02, 0.0, "–ù—É–ª–µ–≤–æ–µ dp15 - –¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –Ω–æ–ª—å"),
        (0.15, 0.05, "–í—ã—Å–æ–∫–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å"),
        (0.01, 0.12, "–ù–∏–∑–∫–∞—è –∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å"),
        (0.08, 0.002, "–≠–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–æ –º–∞–ª–æ–µ dp15"),
    ]
    
    print("–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ (s):")
    print("ŒîP_5m  | –°—Ç–∞—Ä–∞—è s | –ù–æ–≤–∞—è s | –£–ª—É—á—à–µ–Ω–∏–µ")
    print("-" * 45)
    
    for dp5, dp15, desc in test_cases:
        s_old, _ = old_formulas(dp5, dp15)
        s_new, _ = new_formulas(dp5, dp15)
        improvement = "‚úÖ" if abs(s_new - s_old) < 0.3 else "üîß"
        print(f"{dp5:5.3f}  |  {s_old:.3f}   |  {s_new:.3f}   | {improvement} {desc}")
    
    print()
    print("–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ momentum (m):")
    print("ŒîP_5m  | ŒîP_15m | –°—Ç–∞—Ä–∞—è m | –ù–æ–≤–∞—è m | –ü—Ä–æ–±–ª–µ–º–∞")
    print("-" * 55)
    
    for dp5, dp15, desc in test_cases:
        _, m_old = old_formulas(dp5, dp15)
        _, m_new = new_formulas(dp5, dp15)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
        is_extreme = m_old > 0.9 and dp15 < 0.01
        problem = "‚ùå –≠–∫—Å—Ç—Ä–µ–º—É–º" if is_extreme else "‚úÖ –ù–æ—Ä–º–∞"
        
        print(f"{dp5:5.3f}  | {dp15:6.3f} |  {m_old:.3f}   |  {m_new:.3f}   | {problem}")
    
    print()
    print("–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –ª–æ–≥–∞—Ä–∏—Ñ–º–∏—á–µ—Å–∫–æ–≥–æ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏:")
    print("ŒîP_5m  | –õ–∏–Ω–µ–π–Ω–∞—è | –õ–æ–≥–∞—Ä–∏—Ñ–º. | –†–∞–∑–Ω–∏—Ü–∞")
    print("-" * 42)
    
    volatility_test = [0.01, 0.02, 0.05, 0.08, 0.10, 0.15, 0.20]
    
    for vol in volatility_test:
        linear = _clip01(vol / 0.1)  # –°—Ç–∞—Ä–∞—è —Ñ–æ—Ä–º—É–ª–∞
        logarithmic = _clip01(math.log(1 + vol * 10) / math.log(11))  # –ù–æ–≤–∞—è
        diff = abs(linear - logarithmic)
        print(f"{vol:5.3f}  |  {linear:.3f}   |   {logarithmic:.3f}    | {diff:.3f}")
    
    print()
    print("–ö–ª—é—á–µ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:")
    print("‚úÖ –í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å: –ª–æ–≥–∞—Ä–∏—Ñ–º–∏—á–µ—Å–∫–æ–µ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –≤–º–µ—Å—Ç–æ –ª–∏–Ω–µ–π–Ω–æ–≥–æ")
    print("‚úÖ Momentum: –∑–∞—â–∏—Ç–∞ –æ—Ç –¥–µ–ª–µ–Ω–∏—è –Ω–∞ –æ—á–µ–Ω—å –º–∞–ª—ã–µ —á–∏—Å–ª–∞") 
    print("‚úÖ –ë–æ–ª–µ–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏—è—Ö")
    print("‚úÖ –ú–µ–Ω—å—à–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ –∏ —Ä–µ–∑–∫–∏—Ö —Å–∫–∞—á–∫–æ–≤")


if __name__ == "__main__":
    demo_improvements()
