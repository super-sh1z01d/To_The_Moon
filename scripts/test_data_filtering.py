#!/usr/bin/env python3
"""
–¢–µ—Å—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∏ –¥–µ—Ç–µ–∫—Ü–∏–∏ –∞–Ω–æ–º–∞–ª–∏–π.
"""

from __future__ import annotations

import sys
import logging
from src.core.json_logging import configure_logging
from src.domain.validation.data_filters import (
    filter_low_liquidity_pools,
    detect_price_anomalies,
    sanitize_price_changes,
    validate_metrics_consistency,
    should_skip_score_update,
    smooth_liquidity_changes,
)


def test_data_filtering():
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç —Ñ—É–Ω–∫—Ü–∏–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö."""
    configure_logging(level="INFO")
    log = logging.getLogger("filtering_test")
    
    print("üõ°Ô∏è –¢–µ—Å—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∏ –¥–µ—Ç–µ–∫—Ü–∏–∏ –∞–Ω–æ–º–∞–ª–∏–π")
    print("=" * 55)
    print()
    
    # 1. –¢–µ—Å—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø—É–ª–æ–≤ –ø–æ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏
    print("1. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø—É–ª–æ–≤-–ø—ã–ª–∏–Ω–æ–∫:")
    test_pairs = [
        {"liquidity": {"usd": 50000}, "dexId": "raydium", "pairAddress": "addr1"},
        {"liquidity": {"usd": 50}, "dexId": "orca", "pairAddress": "addr2"},      # –ü—ã–ª–∏–Ω–∫–∞
        {"liquidity": {"usd": 15000}, "dexId": "meteora", "pairAddress": "addr3"},
        {"liquidity": {"usd": 200}, "dexId": "pumpswap", "pairAddress": "addr4"},  # –ü—ã–ª–∏–Ω–∫–∞
        {"liquidity": {"usd": 25000}, "dexId": "jupiter", "pairAddress": "addr5"},
    ]
    
    filtered = filter_low_liquidity_pools(test_pairs, min_liquidity_usd=500)
    print(f"   –ò—Å—Ö–æ–¥–Ω—ã—Ö –ø—É–ª–æ–≤: {len(test_pairs)}")
    print(f"   –ü–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏: {len(filtered)}")
    print(f"   –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –ø—ã–ª–∏–Ω–æ–∫: {len(test_pairs) - len(filtered)} ‚úÖ")
    print()
    
    # 2. –¢–µ—Å—Ç –¥–µ—Ç–µ–∫—Ü–∏–∏ –∞–Ω–æ–º–∞–ª–∏–π —Ü–µ–Ω—ã
    print("2. –î–µ—Ç–µ–∫—Ü–∏—è –∞–Ω–æ–º–∞–ª–∏–π –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω—ã:")
    price_test_cases = [
        (0.05, 0.08, "–ù–æ—Ä–º–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è"),
        (0.6, 0.1, "–≠–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–æ–µ 5–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ (60%)"),
        (0.08, 0.002, "–ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–∞—è —Ä–∞–∑–Ω–æ—Å—Ç—å (40x)"),
        (0.02, 0.03, "–°—Ç–∞–±–∏–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è"),
        (-0.7, 0.05, "–ö—Ä–∞—Ö —Ü–µ–Ω—ã (-70%)"),
    ]
    
    for dp5, dp15, desc in price_test_cases:
        is_anomaly = detect_price_anomalies(dp5, dp15, max_change=0.5)
        status = "‚ùå –ê–Ω–æ–º–∞–ª–∏—è" if is_anomaly else "‚úÖ –ù–æ—Ä–º–∞"
        print(f"   dp5={dp5:6.1%}, dp15={dp15:6.1%} | {status} | {desc}")
    
    print()
    
    # 3. –¢–µ—Å—Ç –æ—á–∏—Å—Ç–∫–∏ –∞–Ω–æ–º–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
    print("3. –û—á–∏—Å—Ç–∫–∞ —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π:")
    for dp5, dp15, desc in [(0.8, 0.1, "–≠–∫—Å—Ç—Ä–µ–º 5–º"), (-0.9, 0.05, "–ö—Ä–∞—Ö"), (0.3, 0.6, "–û–±–∞ —ç–∫—Å—Ç—Ä–µ–º–∞")]:
        clean_dp5, clean_dp15 = sanitize_price_changes(dp5, dp15, max_change=0.5)
        print(f"   –ë—ã–ª–æ: {dp5:5.1%}/{dp15:5.1%} ‚Üí –°—Ç–∞–ª–æ: {clean_dp5:5.1%}/{clean_dp15:5.1%} | {desc}")
    
    print()
    
    # 4. –¢–µ—Å—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
    print("4. –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –º–µ—Ç—Ä–∏–∫:")
    consistency_cases = [
        {"L_tot": 5000, "n_5m": 50, "delta_p_5m": 0.02},      # –ù–æ—Ä–º–∞
        {"L_tot": 50000, "n_5m": 0, "delta_p_5m": 0.01},      # –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ: –≤—ã—Å–æ–∫–∞—è –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å, –Ω–µ—Ç —Å–¥–µ–ª–æ–∫
        {"L_tot": 15000, "n_5m": 250, "delta_p_5m": 0.0001},  # –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ: –º–Ω–æ–≥–æ —Å–¥–µ–ª–æ–∫, –Ω–µ—Ç –¥–≤–∏–∂–µ–Ω–∏—è
        {"L_tot": 8000, "n_5m": 30, "delta_p_5m": 0.05},      # –ù–æ—Ä–º–∞
    ]
    
    for i, metrics in enumerate(consistency_cases):
        is_valid = validate_metrics_consistency(metrics)
        status = "‚úÖ –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ" if is_valid else "‚ùå –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ"
        print(f"   –°–ª—É—á–∞–π {i+1}: L=${metrics['L_tot']}, N={metrics['n_5m']}, Œî={metrics['delta_p_5m']:.1%} | {status}")
    
    print()
    
    # 5. –¢–µ—Å—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å–∫–æ—Ä–∞
    print("5. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å–∫–æ—Ä–∞:")
    score_cases = [
        (0.5, 0.52, "–ú–∞–ª–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ (+2%)"),
        (0.5, 0.56, "–ó–Ω–∞—á–∏–º–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ (+6%)"),
        (0.3, 0.302, "–®—É–º (+0.2%)"),
        (0.7, 0.85, "–ö—Ä—É–ø–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ (+15%)"),
    ]
    
    for prev, new, desc in score_cases:
        should_skip = should_skip_score_update(new, prev, min_change=0.05)
        status = "‚è≠Ô∏è –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å" if should_skip else "‚úÖ –û–±–Ω–æ–≤–∏—Ç—å"
        change_pct = (new - prev) * 100
        print(f"   {prev:.3f} ‚Üí {new:.3f} ({change_pct:+.1f}%) | {status} | {desc}")
    
    print()
    
    # 6. –¢–µ—Å—Ç —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è —Ä–µ–∑–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏
    print("6. –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ —Ä–µ–∑–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏:")
    liquidity_cases = [
        (10000, 12000, "–ù–æ—Ä–º–∞–ª—å–Ω–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ (+20%)"),
        (10000, 50000, "–†–µ–∑–∫–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ (+400%)"),
        (10000, 2000, "–†–µ–∑–∫–æ–µ —Å–Ω–∏–∂–µ–Ω–∏–µ (-80%)"),
        (10000, 8000, "–£–º–µ—Ä–µ–Ω–Ω–æ–µ —Å–Ω–∏–∂–µ–Ω–∏–µ (-20%)"),
    ]
    
    for prev, new, desc in liquidity_cases:
        smoothed = smooth_liquidity_changes(new, prev, max_ratio=3.0)
        if smoothed != new:
            change_desc = f"–û–≥—Ä–∞–Ω–∏—á–µ–Ω–æ: ${new:,.0f} ‚Üí ${smoothed:,.0f}"
        else:
            change_desc = "–ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π"
        print(f"   ${prev:,} ‚Üí ${new:,} | {change_desc} | {desc}")
    
    print()
    
    # –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    print("üéâ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:")
    print("‚úÖ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø—É–ª–æ–≤-–ø—ã–ª–∏–Ω–æ–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç")
    print("‚úÖ –î–µ—Ç–µ–∫—Ü–∏—è –∞–Ω–æ–º–∞–ª–∏–π —Ü–µ–Ω—ã —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç")
    print("‚úÖ –û—á–∏—Å—Ç–∫–∞ —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –∞–∫—Ç–∏–≤–Ω–∞")
    print("‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç–∞–µ—Ç")
    print("‚úÖ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞")
    print("‚úÖ –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ —Ä–µ–∑–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ")
    print()
    print("üìä –û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç: –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Å–Ω–∏–∂–µ–Ω–∏–µ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ –Ω–∞ 15-25%")


if __name__ == "__main__":
    test_data_filtering()
